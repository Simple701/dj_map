<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <!-- Bootstrap core CSS -->
    <link href="http://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="{{ url_for('static', filename='blog.css') }}">


  <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=LGnZS0Wj2YrBO3dQQtUtkA6O"></script>
  <script type="text/javascript" src="http://api.map.baidu.com/library/RichMarker/1.2/src/RichMarker.js"></script>
  <script type="text/javascript" src="http://api.map.baidu.com/library/MarkerTool/1.2/src/MarkerTool_min.js"></script>

  <title>添加自定义覆盖物</title>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="blog-masthead">
      <div class="container">
        <nav class="blog-nav">
          <a class="blog-nav-item active" href="#">Home</a>
          <a class="blog-nav-item" href="#">New features</a>
          <a class="blog-nav-item" href="#">Press</a>
          <a class="blog-nav-item" href="#">New hires</a>
          <a class="blog-nav-item" href="#" onclick="selectStyle()">添加标注</a>
        </nav>
      </div>
    </div>

    <div class="container">

      <div >
        <div class="row">
          <div class="col-sm-12" id="allmap">
          </div>
        </div>
      </div>

      <div class="row">
        <input type="button" value="关闭" onclick="mkrTool.close()" />

        <div class="col-sm-8 blog-main">

          <div class="blog-post">
            <h2 class="blog-post-title">New feature</h2>
            <p class="blog-post-meta">December 14, 2013 by <a href="#">Chris</a></p>

            <p>Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Aenean lacinia bibendum nulla sed consectetur. Etiam porta sem malesuada magna mollis euismod. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus.</p>
            <ul>
              <li>Praesent commodo cursus magna, vel scelerisque nisl consectetur et.</li>
              <li>Donec id elit non mi porta gravida at eget metus.</li>
              <li>Nulla vitae elit libero, a pharetra augue.</li>
            </ul>
            <p>Etiam porta <em>sem malesuada magna</em> mollis euismod. Cras mattis consectetur purus sit amet fermentum. Aenean lacinia bibendum nulla sed consectetur.</p>
            <p>Donec ullamcorper nulla non metus auctor fringilla. Nulla vitae elit libero, a pharetra augue.</p>
          </div><!-- /.blog-post -->

          <nav>
            <ul class="pager">
              <li><a href="#">Previous</a></li>
              <li><a href="#">Next</a></li>
            </ul>
          </nav>

        </div><!-- /.blog-main -->

        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          <div class="sidebar-module sidebar-module-inset">
            <h4>About</h4>
            <p>Etiam porta <em>sem malesuada magna</em> mollis euismod. Cras mattis consectetur purus sit amet fermentum. Aenean lacinia bibendum nulla sed consectetur.</p>
          </div>
          <div class="sidebar-module">
            <h4>Archives</h4>
            <ol class="list-unstyled">
              <li><a href="#">March 2014</a></li>
              <li><a href="#">February 2014</a></li>
              <li><a href="#">January 2014</a></li>
              <li><a href="#">December 2013</a></li>
              <li><a href="#">November 2013</a></li>
              <li><a href="#">October 2013</a></li>
              <li><a href="#">September 2013</a></li>
              <li><a href="#">August 2013</a></li>
              <li><a href="#">July 2013</a></li>
              <li><a href="#">June 2013</a></li>
              <li><a href="#">May 2013</a></li>
              <li><a href="#">April 2013</a></li>
            </ol>
          </div>
          <div class="sidebar-module">
            <h4>Elsewhere</h4>
            <ol class="list-unstyled">
              <li><a href="#">GitHub</a></li>
              <li><a href="#">Twitter</a></li>
              <li><a href="#">Facebook</a></li>
            </ol>
          </div>
        </div><!-- /.blog-sidebar -->
<img src="../static/1024.jpg"></img>
      </div><!-- /.row -->

    </div><!-- /.container -->



<div id="left-panel" class="col-lg-3">
<div id="searchbox" class="input-group">
<input id="sole-input" class="form-control" type="text" placeholder="搜地点、查公交、找路线" value="">
<span class="input-group-btn">
<button type="commit" class="btn btn-default" onclick="go_search()">Search</button>
</span>
</div>
<div id="toast-wrapper">
</div>
</div>
<ul id="cards-level0" class="cardlist"></ul>
<ul id="cards-level1" class="cardlist"></ul>
<ul id="cards-level2" class="cardlist"></ul>
</div>



    <footer class="blog-footer">
      <p>Blog template built for <a href="http://getbootstrap.com">Bootstrap</a> by <a href="https://twitter.com/mdo">@mdo</a>.</p>
      <p>
        <a href="#">Back to top</a>
      </p>
    </footer>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  </body>
</html>
<script type="text/javascript">
  // Map INIT 
  var markers ={% autoescape false %}  {{ mk }} {% endautoescape %} ;
  var mp = new BMap.Map("allmap");
  var geoc = new BMap.Geocoder(); 
  mp.centerAndZoom(new BMap.Point(116.3964,31.9093), 5);
  //地图配置
  mp.disablePinchToZoom();
  var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
  var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
  mp.addControl(top_left_control);        
  mp.addControl(top_left_navigation); 

  //search INIT 
  var local = new BMap.LocalSearch(mp, {
    renderOptions: {map: mp, panel: "toast-wrapper"},
    pageCapacity:6
  });
  function go_search(){
    var s_text = $("#sole-input").val() ;
    local.search(s_text);
  }
  //right menu INIT 
  mp.addEventListener("rightclick", function(e){    
      var pt = e.point; 
      var menu = new BMap.ContextMenu();
      var txtMenuItem = [
        {
          text:'添加标注',
          callback:function(){ 
            var marker2 = new BMap.Marker(pt);  // 创建标注
            mp.addOverlay(marker2);
            add_infowindow(marker2); 
          }
        }
      ];
      for(var i=0; i < txtMenuItem.length; i++){
        menu.addItem(new BMap.MenuItem(txtMenuItem[i].text,txtMenuItem[i].callback,100));
      }
      mp.addContextMenu(menu);
  })
  //curent var INIT 
  var curMkr = null; 




  function get_icon(i_ty){
      var myIcon = new BMap.Icon("../static/1024.jpg", new BMap.Size(16,22));
      myIcon.setImageSize(new BMap.Size(300,80));
      myIcon.setImageOffset(new BMap.Size(-158,-24));
      myIcon.setAnchor(new BMap.Size(8,12))
      return myIcon ;
  }


  //add function for markers 
  function addClickHandler(content,marker){ 
    marker.addEventListener("click",function(e){ 
      var p = e.target;
      marker.setTop(true);
      openInfo(content,e);
    });
  }
  function openInfo(content,e){
    var p = e.target;
    var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
    var infoWindow = new BMap.InfoWindow(content);  // 创建信息窗口对象 
    mp.openInfoWindow(infoWindow,point); //开启信息窗口
    mp.panTo(point); 
  } 
  // 复杂的自定义覆盖物
  function addMyMarker(m_point,m_title,m_img){
    myMarker = new BMap.Marker(m_point,{icon:get_icon(1)});
    mp.addOverlay(myMarker);
    var content ="<h4 style='margin:0 0 5px 0;padding:0.2em 0'>"+markers[i].title+"</h4></div>";
    addClickHandler(content,myMarker);

  }
  //增加自定义覆盖物
  for(var i in markers){
    console.log(markers[i].title);
    addMyMarker(new BMap.Point(markers[i].pointx,markers[i].pointy),markers[i].title,'http://img.qqtouxiangzq.com/1/403/13.jpg');
  }

  //拼接infowindow内容字串
  function add_infowindow(mkr){ 
    var pt = mkr.getPosition();
    mkr.setTop(true);
    mkr.addEventListener("infowindowclose", function(){ 
      mp.removeOverlay(mkr);
    });
    mp.panTo(pt); 
    geoc.getLocation(pt, function(rs){
      var m_info = rs.address;
      var html = [];
      html.push('<span class="label label-info "> ~添加地点~ </span><br/><br/>');
      html.push('<form id="mark" method="post" action="/mark_add">');
      html.push('<div class="form-group">');
      html.push('  <label for="mark_name">名称:</label>');
      html.push('  <input type="text" class="form-control" name="mark_name" value="'+m_info+'">');
      html.push('</div>');
      html.push('  <div class="form-group">');
      html.push('  <label for="mark_type">类型:</label>');
      html.push('  <input type="text" class="form-control" name="mark_type" >');
      html.push('</div>');
      html.push('  <div class="form-group">');
      html.push('  <label for="mark_time">时间:</label>');
      html.push('  <input type="text" class="form-control" name="mark_time" >');
      html.push('</div>');
      html.push('  <div class="form-group">');
      html.push('    <div class="center">');
      html.push('      <button type="submit" class="btn btn-default">Submit</button>');
      html.push('    </div>');
      html.push('  <input type="hidden" name="mark_loc" value="'+pt.lng+','+pt.lat+'">');
      html.push('  </div>');
      html.push('</form>');
      var infoWin = new BMap.InfoWindow(html.join(""), {offset: new BMap.Size(0, -2)});
      curMkr = mkr;
      mkr.openInfoWindow(infoWin);
    }); 
  }

var mkrTool = new BMapLib.MarkerTool(mp, {followText: "",autoClose: true});
mkrTool.addEventListener("markend", function(evt){ 
    var mkr = evt.marker; 
    add_infowindow(mkr);
});

//选择样式
function selectStyle(){
    mkrTool.open(); //打开工具 
    var icon = BMapLib.MarkerTool.SYS_ICONS[7]; //设置工具样式，使用系统提供的样式BMapLib.MarkerTool.SYS_ICONS[0] -- BMapLib.MarkerTool.SYS_ICONS[23]
    mkrTool.setIcon(icon); 
}

//提交数据
function fnOK(){
    var name = encodeHTML(document.getElementById("txtName").value);
    var tel = encodeHTML(document.getElementById("txtTel").value);
    var addr = encodeHTML(document.getElementById("txtAddr").value);
    var desc = encodeHTML(document.getElementById("areaDesc").value);

    if(!name || !tel || !addr){
        alert("星号字段必须填写");    
        return;
    }

    if(curMkr){
        //设置label
        var lbl = new BMap.Label(name, {offset: new BMap.Size(1, 1)});
        lbl.setStyle({border: "solid 1px gray"});
        curMkr.setLabel(lbl);
        alert(curMkr.getPosition().lng);
        
        //设置title
        var title = "电话: " + tel + "\n\r" + "地址: " +addr + "\n\r" + "描述: " + desc;
        curMkr.setTitle(title);        
    }
    if(infoWin.isOpen()){
        mp.closeInfoWindow();
    }

    //在此用户可将数据提交到后台数据库中
}

//输入校验
function encodeHTML(a){
  return a.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

//重填数据
function fnClear(){
    document.getElementById("txtName").value = "";
    document.getElementById("txtTel").value = "";
    document.getElementById("txtAddr").value = "";
    document.getElementById("areaDesc").value = "";
}
</script>
